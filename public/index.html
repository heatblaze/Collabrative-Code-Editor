<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Code Editor</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body style="background: linear-gradient(to right, #6F5DF5, #B261EA, #F564DF);" class="min-h-screen flex items-center justify-center">

    <div id="sign-in-page" class="w-full sm:w-96 bg-white/30 backdrop-blur-md border border-white/20 p-8 rounded-xl shadow-lg transform transition-all duration-500 hover:scale-105 ease-in-out">
        <h2 class="text-3xl font-bold text-center text-gray-700 mb-6">Sign In</h2>

        <div id="sign-in-form" class="space-y-4">
            <button id="sign-in-btn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                Sign In Anonymously
            </button>
            <p class="text-sm text-center text-gray-600">By signing in, you agree to our terms and conditions.</p>
        </div>

        <div id="loading-spinner" class="hidden justify-center items-center text-center">
            <svg class="animate-spin w-12 h-12 mx-auto text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                <path fill="currentColor" d="M4 12a8 8 0 0116 0 8 8 0 01-16 0z" class="opacity-75"></path>
            </svg>
            <p class="mt-4 text-white">Signing in...</p>
        </div>
    </div>

    <div id="editor-page" class="hidden w-full sm:w-3/4 bg-white p-8 rounded-xl shadow-lg space-y-4">
        <div id="editor" class="border-2 border-gray-400 rounded-lg shadow-md" style="height: 400px;"></div>

        <div class="flex justify-between items-center space-x-4">
            <select id="language-selector" class="border p-2 rounded-md">
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
            </select>
            <button id="run-btn" class="bg-green-500 text-white px-4 py-2 rounded">Run</button>
            <button id="save-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
        </div>

        <div id="output-box" class="mt-4 p-4 bg-gray-800 text-white rounded-md">
            <h3 class="font-bold">Output:</h3>
            <pre id="output-content" class="whitespace-pre-wrap overflow-auto">Waiting for code execution...</pre>
        </div>

        <div id="terminal" class="mt-4 p-4 bg-black text-white rounded-md">
            <h3 class="font-bold">Terminal:</h3>
            <textarea id="terminal-content" class="whitespace-pre-wrap overflow-auto w-full h-32 bg-black text-white" placeholder="Type here..." rows="10"></textarea>
        </div>

        <div id="user-info" class="flex justify-between items-center space-x-4 mt-4">
            <button id="sign-out-btn" class="bg-red-500 text-white px-4 py-2 rounded">Sign Out</button>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://nvmvthxmatuhpzwhlblb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52bXZ0aHhtYXR1aHB6d2hsYmxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NjM4ODAsImV4cCI6MjA3NzEzOTg4MH0.r-gXajpuoyYbRzQuobQHpNMzsYedWUZYpzt3Z1bsAIY';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let editor;
        let socket;

        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' } });

        window.onload = () => {
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: '',
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true
                });

                socket = io("http://localhost:3000");

                document.getElementById('language-selector').addEventListener('change', (e) => {
                    const language = e.target.value;
                    monaco.editor.setModelLanguage(editor.getModel(), language);
                });

                document.getElementById('save-btn').addEventListener('click', () => {
                    const code = editor.getValue();
                    const filename = 'codefile.txt';

                    const blob = new Blob([code], { type: 'text/plain' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                });

                document.getElementById('run-btn').addEventListener('click', () => {
                    const code = editor.getValue();
                    const language = document.getElementById('language-selector').value;

                    console.log('Code:', code);
                    console.log('Language:', language);

                    socket.emit('run-code', { code, language });
                });

                socket.on('code-output', (data) => {
                    document.getElementById('output-content').textContent = data.output || 'No output available';
                    document.getElementById('terminal-content').textContent = data.terminal || 'No terminal output available';
                });

                let debounceTimeout;
                const DEBOUNCE_DELAY = 500;

                editor.getModel().onDidChangeContent(() => {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(async () => {
                        const code = editor.getValue();
                        await saveCodeToSupabase(code);
                    }, DEBOUNCE_DELAY);
                });
            });
        };

        const loadCodeFromSupabase = async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                const { data, error } = await supabaseClient
                    .from('user_codes')
                    .select('code')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (data && data.code) {
                    editor.setValue(data.code);
                }
            }
        };

        const saveCodeToSupabase = async (code) => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                const { error } = await supabaseClient
                    .from('user_codes')
                    .upsert({ user_id: user.id, code: code }, { onConflict: 'user_id' });

                if (error) {
                    console.error('Error saving code:', error);
                }
            }
        };

        document.getElementById('sign-in-btn').addEventListener('click', async () => {
            try {
                const { data, error } = await supabaseClient.auth.signInAnonymously();

                if (error) {
                    console.error('Sign-in error:', error.message);
                    alert('Sign-in failed: ' + error.message);
                    return;
                }

                console.log('Signed in anonymously:', data);
                document.getElementById('sign-in-page').classList.add('hidden');
                document.getElementById('editor-page').classList.remove('hidden');

                await loadCodeFromSupabase();
            } catch (error) {
                console.error('Sign-in error:', error.message);
                alert('Sign-in failed: ' + error.message);
            }
        });

        document.getElementById('sign-out-btn').addEventListener('click', async () => {
            try {
                await supabaseClient.auth.signOut();
                console.log('Signed out');
                document.getElementById('sign-in-page').classList.remove('hidden');
                document.getElementById('editor-page').classList.add('hidden');
            } catch (error) {
                console.error('Sign-out error:', error.message);
            }
        });
    </script>
</body>
</html>
